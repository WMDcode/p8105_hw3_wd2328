---
title: "Homework 3"
subtitle: "P8105 Data Science"
author: "William Donovan"
output: github_document
---

```{r message=FALSE, warning=FALSE}
# Loading packages
library(tidyverse)
library(paletteer)
library(ggridges)
library(patchwork)
library(hms)
```

# Problem 1

```{r}
# Loading in Instacart dataset
library(p8105.datasets)
data("instacart")

# A quick look at the structure of the dataset
str(instacart)
```

The dataset includes `r ncol(instacart)` columns and `r nrow(instacart)` rows, containing information about customer grocery orders placed through the Instacart app. Each row represents a single product within an order and its associated details. Key variables include `order_id`, `product_id`, `add_to_cart_order` (the position of the item in the cart), `reordered` (binary indicator for whether the customer had previously ordered the item), `user_id`, and `eval_set` (always set to “train,” indicating this dataset is likely used for model training). Additional variables describe ordering behavior, such as `order_number` (sequence of the customer’s orders), `order_dow` (day of the week, coded 0–6), `order_hour_of_day` (hour of the day, coded 0–23), and `days_since_prior_order` (days since the customer’s previous order). Product-level information includes `product_name`, `aisle_id`, `department_id`, `aisle`, and `department`.

As a random example:
```{r}
t(instacart[123,])
```
This example shows us that customer 51011 submitted an order (order ID 226) at about noon (hour 12) on the first day of the week (day 0). This was the customer's 4th order, and 30 days since they ordered previously. The particular product ordered under this observation was organic blueberries (product ID 39275). This was the 9th item added to the cart and the first time the customer had ordered this item. Organic blueberries are found in the "packaged vegetables fruits" aisle (aisle ID 123) in the produce department (department ID 4).

A few insights we can pull from the data:
```{r}
# Aisles and number of ordered items
instacart |>
  count(aisle, sort = TRUE)
```
There are `r length(unique(pull(instacart, aisle)))` aisles, and the top 3 aisles (in terms of ordered items) are "fresh vegetables", "fresh fruits", and "packaged vegetables fruits".

Looking at aisles containing more than 10000 items ordered.
```{r}
instacart |>
  group_by(aisle, department) |>
  summarise(ordered_items = n(), .groups = "drop") |>
  filter(ordered_items > 10000) |>
  mutate(aisle = fct_reorder(aisle, department)) |>
  ggplot(aes(y = aisle, x = ordered_items, fill = department)) +
  geom_col() +
  scale_fill_manual(values = paletteer_d("ggthemes::Tableau_20")) +
  scale_y_discrete(limits = rev) +
  theme_bw() +
  labs(
    title = "Products Ordered by Aisle",
    x = "Ordered products",
    y = "Aisle",
    fill = "Department")
```

This visualization highlights the most heavily trafficked aisles across departments. As pointed out earlier, produce is the most commonly ordered from department. This is followed by dairy eggs. It's also interesting to see that the popular snack and beverage aisles are chips and selzer water.

Looking at popular items in specific aisles.
```{r}
instacart |>
  group_by(aisle) |>
  filter(aisle %in% c("baking ingredients", 
                    "dog food care", 
                    "packaged vegetables fruits")) |>
  count(product_name, sort = TRUE, name = "num_ordered") |>
  slice(1:3)
```

From this quick table, the most popular items of the aisles "baking ingredients", "dog food care", and "packaged vegetables fruits", are light brown sugar, chicken & rice dog snack sticks, and organic baby spinach, respectively.

Looking at when pink lady apples and coffee ice cream are usually ordered on each day of the week.
```{r}
instacart |>
  filter(product_name %in% c("Pink Lady Apple",
                           "Coffee Ice Cream")) |>
  group_by(product_name, order_dow) |>
  summarise(mean_hour = mean(order_hour_of_day), .groups = "drop") |>
  mutate(
    hour = floor(mean_hour),
    minute = round((mean_hour - hour) * 60),
    clock_time = sprintf("%02d:%02d", hour, minute),
    day_of_week = order_dow + 1,
    day_of_week = wday(day_of_week, label = TRUE),
    combined_time = paste(day_of_week, clock_time)) |>
  select(product_name, day_of_week, combined_time) |>
  pivot_wider(names_from = product_name,
              values_from = combined_time) |>
  select(-day_of_week) |>
  knitr::kable()
```

On average, pink lady apples and coffee ice cream are ordered during the afternoon hours most days of the week. The exception is for pink lady apples, which, on average, are ordered in the mornings on Wednesdays and Thursdays.

# Problem 2

`Zip Codes.csv` data-frame
```{r message=FALSE}
zipcodes_df = read_csv("data/Zip Codes.csv", na = "NA") |>
  janitor::clean_names() |>
  select(-c(state_fips, county_code, file_date))
```

`Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv` data-frame
```{r message=FALSE}
zillow_df = read_csv("data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv", na = "NA") |>
  janitor::clean_names() |>
  pivot_longer(
    cols = x2015_01_31:x2024_08_31,
    names_to = "date",
    values_to = "zillow_observed_rent_index") |>
  select(-c(region_type, state_name, metro)) |>
  rename(zip_code = region_name,
         county = county_name) |>
  mutate(
    date = ymd(str_remove(date, "x")),
    county = str_remove(county, " County"))
```

Joining datasets
```{r}
problem2_df = full_join(zillow_df, zipcodes_df, by = c("county", "zip_code")) |>
  select(
    c(date,
      city,
      state,
      zip_code,
      county,
      county_fips,
      neighborhood,
      region_id,
      size_rank,
      zillow_observed_rent_index))
```

How many zip codes are observed every month in the dataset (all 116 months 2015-2024)?
```{r}
problem2_df |>
  filter(!is.na(zillow_observed_rent_index)) |>
  count(zip_code, sort = TRUE) |>
  filter(n == 116) |>
  nrow()
```

There are 48 ZIP codes observed all 116 months.

How many zip codes are observed fewer than 10 times out of the 116 possible observations?
```{r}
problem2_df |>
  count(zip_code, sort = TRUE) |>
  filter(n < 10) |>
  nrow()
```

There were 171 ZIP codes in the dataset which were observed fewer than 10 times.

Due to the nature of variations in size and location, some ZIP codes may have more data than others. If there's not a large enough rental sample size, the Zillow Observed Rent Index (ZORI) may not be accurate and is not reported. This is why some ZIP codes have ZORI observations for every month and others have very few.

Below is the average rental price over time in each borough
```{r}
problem2_df |>
  filter(!is.na(zillow_observed_rent_index)) |>
  group_by(county, 
           Year = year(date)) |>
  summarise(mean_rent = mean(zillow_observed_rent_index),
            .groups = "drop") |>
  pivot_wider(names_from = county,
              values_from = mean_rent) |>
  rename(Brooklyn = Kings,
         Manhattan = 'New York',
         'Staten Island' = Richmond) |>
  knitr::kable()
```

This table shows that rental prices have gone up every year since 2015, except for 2020, due to the Covid-19 pandemic. In 2020, rental prices decreased across New York City, but notably, the largest average decrease was in Manhattan. Staten Island does not have ZORI scores before 2020 due to a lack of data from Richmond County during that time period.

Comparing rental prices between ZIP codes over time:
```{r message=FALSE}
# Set seed for randomized line plotting order
set.seed(24)

zip_code_rent = problem2_df |>
  filter(!is.na(zillow_observed_rent_index)) |>
  mutate(
    Borough = case_match(county,
      "New York" ~ "Manhattan",
      "Richmond" ~ "Staten Island",
      "Kings" ~ "Brooklyn",
      .default = county)) |>
  mutate(zip_code = forcats::fct_shuffle(as.factor(zip_code))) |>
  ggplot(aes(x = date, 
             y = zillow_observed_rent_index, 
             group = zip_code)) +
  geom_line(aes(color = Borough), 
            linewidth = 0.8) +
  scale_color_manual(values = c("Bronx" = "#4E79A7",
                                "Brooklyn" = "#A0CBE8",
                                "Manhattan" = "#F28E2B",
                                "Queens" = "#E15759",
                                "Staten Island" = "#59A14F"),
                     name = "Borough") +
  theme_bw() +
  labs(
    title = "NYC Rental Index by ZIP Code",
    x = "Date",
    y = "Zillow Observered Rent Index")

zip_code_rent
```

Each line in the plot above represents the rental index data of a single ZIP code in New York City. The lines are differentiated by color to designate which borough the ZIP code belongs to. The general trend is increasing rent. However, for nearly all NYC ZIP codes, there is a decrease in rent in 2020 due to the Covid-19 pandemic. This decrease is more pronounced in areas where rent is higher, such as Manhattan and Brooklyn ZIP codes. Rent for many ZIP codes in the Bronx, Queens, and Staten Island seemed to be less affected in 2020. From the plotted data, it can also be recognized that Manhattan has some of the most expensive areas, while the Bronx has some of the least.

Distribution of average rental index from 2023:
```{r message=FALSE}
rent_distribution = problem2_df |>
  filter(!is.na(zillow_observed_rent_index),
                year(date) == 2023) |>
  mutate(
    Borough = case_match(county,
      "New York" ~ "Manhattan",
      "Richmond" ~ "Staten Island",
      "Kings" ~ "Brooklyn",
      .default = county)) |>
  group_by(zip_code, Borough) |>
  summarise(mean_rent = mean(zillow_observed_rent_index),
            .groups = "drop") |>
  ggplot(aes(x = mean_rent, y = Borough)) +
  geom_density_ridges(aes(fill = Borough),
                      quantile_lines = TRUE,
                      quantile_fun = median,
                      alpha = 0.8) +
  scale_fill_manual(values = c("Bronx" = "#4E79A7",
                                "Brooklyn" = "#A0CBE8",
                                "Manhattan" = "#F28E2B",
                                "Queens" = "#E15759",
                                "Staten Island" = "#59A14F"),
                     name = "Borough") +
  theme_bw() +
  labs(
    title = "Average Rental Index Distribution by Borough in 2023",
    x = "Mean Zillow Observed Rent Index",
    y = "Borough")

rent_distribution
```

The density ridges plot shows the distribution of average rental index across boroughs in 2023. In Staten Island, Queens, and the Bronx, the median rental index is between 2000 and 3000. Manhattan and Brooklyn have the widest distribution of rental indexes. Manhattan is the only borough with a median rental index above 4000. Manhattan also has a couple smaller peaks above 6000 and 7000, showing how expensive some areas in Manhattan can be. Brooklyn's median rental index is just below 3000, but there are many ZIP codes that have higher rental indexes, some reaching up around 5000.

Combining plots:
```{r message=FALSE}
combined_plot = zip_code_rent / rent_distribution

combined_plot

ggsave("results/p2_combined.png", combined_plot)
```

# Problem 3

Loading datasets:
```{r message=FALSE}
# nhanes_covar.csv
covar_df = read_csv("data/nhanes_covar.csv",
                    na = "NA",
                    skip = 4) |>
  janitor::clean_names()

# nhanes_accel.csv
accel_df = read_csv("data/nhanes_accel.csv") |>
  janitor::clean_names()
```

Merging and tidying datasets:
```{r}
problem3_df = left_join(covar_df, accel_df, by = "seqn") |>
  pivot_longer(cols = min1:min1440,
               names_to = "time",
               values_to = "mims") |>
  mutate(
    time = as.numeric(str_remove(time, "min")),
    sex = factor(case_match(
      sex,
      1 ~ "Male",
      2 ~ "Female"), 
      levels = c("Male", "Female")),
    education = factor(case_match(
      education,
      1 ~ "Less than high school",
      2 ~ "High school equivalent",
      3 ~ "More than high school"),
      levels = c(
      "Less than high school",
      "High school equivalent",
      "More than high school"))) |>
  filter(age >= 21,
         !if_any(everything(), is.na))
```

After removing individuals with incomplete demographics information or under 21 years of age, the dataset consists of `r length(unique(pull(filter(problem3_df, sex == "Male"), seqn)))` males and `r length(unique(pull(filter(problem3_df, sex == "Female"), seqn)))` females. Below is the number of males and females for each education level.

```{r}
problem3_df |>
  distinct(seqn, sex, education) |>
  count(sex, education) |>
  pivot_wider(names_from = sex,
              values_from = n) |>
  knitr::kable()
```

The majority of individuals in this dataset have education beyond high school. The split is relatively even between males and females.

Distribution of ages:
```{r}
problem3_df |>
  distinct(seqn, sex, age) |>
  ggplot(aes(x = age, fill = sex)) +
  geom_histogram(bins = 15) +
  facet_grid(. ~ sex) +
  scale_fill_manual(values = paletteer_d("ggthemes::Tableau_10")) +
  theme_bw() +
  labs(
    title = "Age Distribution by Sex",
    x = "Age",
    y = "Count",
    fill = "Sex")
```

Ages of the individuals do not seem to follow any particular distribution. Age distribution between sexes are similar and relatively uniform.

Total activity based on demographics over time:
```{r}
problem3_df |>
  group_by(seqn, sex, age, education) |>
  summarise(activity = sum(mims),
            .groups = "drop") |>
  ggplot(aes(x = age, y = activity)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_grid(sex ~ education) +
  theme_bw() +
  labs(
    title = "Daily Activity by Demographic",
    x = "Age",
    y = "Daily Activity (MIMS units)")
```

The above plot shows individual daily activity by age, split up by demographic. Decreasing activity over time is the general trend for all demographics. The decrease in activity is generally the same for males and females. When comparing different education levels however, activity decreases at a lesser rate as education increases.

Activity levels throughout the day:
```{r}
set.seed(29)

problem3_df |>
  mutate(time = as_hms(time * 60)) |>
  slice_sample(n = 50000) |>
  ggplot(aes(x = time, y = mims, color = sex)) +
  geom_point(alpha = 0.05) +
  geom_smooth(se = FALSE) +
  facet_grid(. ~ education) +
  theme_bw() +
  scale_color_manual(values = paletteer_d("ggthemes::Tableau_10")) +
  labs(
    title = "Activity Levels Throughout the Day",
    x = "Hour of day",
    y = "Activity (MIMS units)",
    color = "Sex") +
  scale_x_time(breaks = as_hms(c(0, 6, 12, 18, 24) * 3600),
               labels = c("0", "6", "12", "18", "24"))
```

While the variation in activity is high among individuals, there are some general trends that can be highlighted. For all demographics, activity levels spike in the morning and then heavily decrease in the evening, which is expected. However, during daytime hours, there is a difference between demographics. Less educated individuals slightly decrease activity through daytime hours before the decrease in the evening, whereas with more education, activity throughout daytime hours levels out. Also, females maintain slightly higher activity levels than males across all demographics.
